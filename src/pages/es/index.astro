---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';

const entries = await getCollection('ai-lab');
const englishTopics = await getCollection('topics');
const spanishTopics = await getCollection('topics-es');
const sorted = entries.sort(
  (a, b) => b.data.date.getTime() - a.data.date.getTime()
);
const logs = sorted.filter((entry) => entry.data.category === 'log');
const experiments = sorted.filter(
  (entry) => entry.data.category === 'experiment'
);
const bootstrappingSlug = logs.find((log) =>
  log.slug.includes('bootstrapping')
)?.slug;

const normalizeModuleKey = (value: string) => {
  const rawKey = value.split(':')[0].trim();
  return rawKey.replace('Módulo', 'Module').replace('Modulo', 'Module');
};

const formatModuleKey = (value: string) => value.replace('Module', 'Módulo');

const moduleSubtopics: Record<
  string,
  { id: string; title: string; summary: string }[]
> = {
  'Module 0': [
    {
      id: 'running-inference-locally',
      title: 'Ejecutar inferencia localmente',
      summary: 'Configura y ejecuta un LLM en tu propia máquina con facilidad.'
    },
    {
      id: 'agent-notifications',
      title: 'Notificaciones del agente',
      summary: 'Recibe notificaciones cuando tu agente termina usando hooks y ntfy.'
    },
    {
      id: 'persistent-agents',
      title: 'Agentes IA persistentes',
      summary: 'Despliega un agente IA siempre activo en un servidor con mensajería y seguridad.'
    },
    {
      id: 'access-secrets',
      title: 'Acceso y secretos',
      summary:
        'Configura claves de API y secretos de forma segura para el acceso al modelo.'
    },
    {
      id: 'safety-baseline',
      title: 'Base de seguridad',
      summary:
        'Aprende conceptos básicos de seguridad como inyección de prompts, uso indebido y manejo de datos.'
    }
  ],
  'Module 1': [
    {
      id: 'llm-interfaces',
      title: 'Interfaces de LLM',
      summary:
        'Trabaja con bibliotecas o runtimes de clientes LLM y patrones de solicitud/respuesta.'
    },
    {
      id: 'inputs-outputs',
      title: 'Entradas y salidas',
      summary:
        'Estructura prompts, mensajes y salidas JSON/herramientas para uso posterior.'
    },
    {
      id: 'model-economics',
      title: 'Economía del modelo',
      summary: 'Tokens, ventanas de contexto, latencia y conceptos básicos de costo.'
    }
  ],
  'Module 2': [
    {
      id: 'prompt-structures',
      title: 'Estructuras de prompts',
      summary: 'Roles, instrucciones, ejemplos, CoT y pistas estilo RAG.'
    },
    {
      id: 'output-evaluation',
      title: 'Evaluación de salidas',
      summary:
        'Compara salidas buenas y malas y ajusta prompts con feedback.'
    },
    {
      id: 'micro-tools',
      title: 'Microherramientas',
      summary: 'Pequeñas utilidades como limpiadores de notas con IA o explicadores.'
    }
  ],
  'Module 3': [
    {
      id: 'retrieval-basics',
      title: 'Fundamentos de recuperación',
      summary:
        'RAG mínimo sobre documentos locales usando embeddings y búsqueda.'
    },
    {
      id: 'tool-wiring',
      title: 'Conexión de herramientas',
      summary: 'Conecta modelos a búsqueda, calculadora o consultas de archivos/BD.'
    },
    {
      id: 'observability',
      title: 'Observabilidad',
      summary: 'Registra prompts/salidas para depurar e iterar con fiabilidad.'
    }
  ],
  'Module 4': [
    {
      id: 'agent-design',
      title: 'Diseño de agentes',
      summary:
        'Uno o dos agentes pequeños (asistente de investigación, automatizador de tareas).'
    },
    {
      id: 'control-flow',
      title: 'Flujo de control',
      summary: 'Compara máquinas de estado con enfoques de prompt en bucle.'
    },
    {
      id: 'resilience',
      title: 'Resiliencia',
      summary: 'Maneja fallos, reintentos y degradaciones con gracia.'
    }
  ],
  'Module 5': [
    {
      id: 'packaging',
      title: 'Empaquetado',
      summary:
        'Empaqueta un proyecto en un CLI o una interfaz web simple (Streamlit/FastAPI).'
    },
    {
      id: 'run-deploy',
      title: 'Ejecución y despliegue',
      summary: 'Documenta cómo ejecutarlo localmente y cómo desplegarlo.'
    },
    {
      id: 'reality-check',
      title: 'Chequeo de realidad',
      summary: 'Señala limitaciones, riesgos y mejoras futuras.'
    }
  ]
};

const buildTopicKey = (topic) => {
  const moduleKey = normalizeModuleKey(topic.data.module);
  return `${moduleKey}:${topic.data.subtopic}`;
};

const englishTopicLookup = englishTopics.reduce((acc, topic) => {
  acc.set(buildTopicKey(topic), topic);
  return acc;
}, new Map<string, (typeof englishTopics)[number]>());

const spanishTopicLookup = spanishTopics.reduce((acc, topic) => {
  acc.set(buildTopicKey(topic), topic);
  return acc;
}, new Map<string, (typeof spanishTopics)[number]>());

const buildTopicHref = (slug: string) => `/es/topics/${slug}/`;

const buildModuleHref = (module) => {
  if (module.link && module.link !== '#') return module.link;
  return '/program';
};

const moduleLadder = [
  {
    key: 'Module 0',
    title: 'Configuración y seguridad',
    status: 'in-progress',
    link: '/es/modules/module-0/',
    subtopics: moduleSubtopics['Module 0']
  },
  {
    key: 'Module 1',
    title: 'Fundamentos para creadores de LLM',
    status: 'planned',
    link: '/modules/module-1/',
    subtopics: moduleSubtopics['Module 1']
  },
  {
    key: 'Module 2',
    title: 'Patrones de prompting y razonamiento',
    status: 'planned',
    link: '/program#module-2',
    subtopics: moduleSubtopics['Module 2']
  },
  {
    key: 'Module 3',
    title: 'Integración de RAG y herramientas',
    status: 'planned',
    link: '/program#module-3',
    subtopics: moduleSubtopics['Module 3']
  },
  {
    key: 'Module 4',
    title: 'Agentes y flujos de trabajo',
    status: 'planned',
    link: '/program#module-4',
    subtopics: moduleSubtopics['Module 4']
  },
  {
    key: 'Module 5',
    title: 'Aplicación LLM productizada',
    status: 'planned',
    link: '/program#module-5',
    subtopics: moduleSubtopics['Module 5']
  }
];

const currentModule =
  moduleLadder.find((item) => item.status === 'in-progress') ?? moduleLadder[0];

const logEntries = await Promise.all(
  logs.map(async (entry) => {
    const { Content } = await entry.render();
    return { ...entry, Content };
  })
);

const experimentCards = await Promise.all(
  experiments.map(async (entry) => {
    const { Content } = await entry.render();
    return { ...entry, Content };
  })
);

const subtopicsForModule = (module) => {
  return (module.subtopics ?? []).map((definition) => {
    const key = `${module.key}:${definition.id}`;
    const spanishTopic = spanishTopicLookup.get(key);
    const topic = spanishTopic ?? englishTopicLookup.get(key);
    const href = topic ? buildTopicHref(topic.slug) : undefined;
    const hasContent = Boolean(topic);

    return {
      title: definition.title,
      summary: spanishTopic?.data.summary ?? definition.summary,
      href,
      disabled: !hasContent
    };
  });
};
---

<BaseLayout
  title="AI Lab"
  description="Laboratorio de IA personal para seguir el crecimiento de cero a un practicante sólido."
>
  <section class="card signal-hero" aria-labelledby="hero-title">
    <div class="signal-overlay" aria-hidden="true"></div>
    <div class="signal-grid" aria-hidden="true"></div>
    <div class="hero-content">
      <h1 id="hero-title">Constructor de LLM y GenAI</h1>
      <p>
        <b>Ruta autodidacta</b> para pasar de cero a lanzar herramientas y agentes
        prácticos basados en LLM, con énfasis en claridad, reproducibilidad y uso
        real dentro del ecosistema Turtleand.
      </p>
    </div>
  </section>

  <section class="card" aria-labelledby="modules-title" id="modules">
    <div class="section-title">
      <div>
        <h2 id="modules-title">Hoja de ruta del programa</h2>
      </div>
      <small
        >Toca un módulo para ver sus temas y saltar a las páginas dedicadas.</small
      >
    </div>
    <div class="stacked">
      {
        moduleLadder.map((module) => {
          const renderedSubtopics = subtopicsForModule(module);
          const hasSubtopics = renderedSubtopics.length > 0;
          const activeSubtopics = renderedSubtopics.filter(
            (topic) => !topic.disabled
          );
          const moduleDisabled = activeSubtopics.length === 0;

          return (
            <details
              class={`module-row ${moduleDisabled ? 'disabled' : ''}`}
              open={
                !moduleDisabled &&
                hasSubtopics &&
                module.status === 'in-progress'
              }
            >
              <summary>
                <div>
                  <strong>{formatModuleKey(module.key)}</strong>
                  <div>{module.title}</div>
                </div>
              </summary>
              <div class="subtopics">
                {hasSubtopics ? (
                  <ul class="subtopic-list">
                    {renderedSubtopics.map((topic) =>
                      topic.href && !topic.disabled ? (
                        <li class="subtopic-bullet">
                          <a class="subtopic-link" href={topic.href}>
                            <span class="bullet-dot" aria-hidden="true" />
                            <div>
                              <div class="subtopic-title">{topic.title}</div>
                              <p>{topic.summary}</p>
                            </div>
                          </a>
                        </li>
                      ) : (
                        <li
                          class="subtopic-bullet disabled"
                          aria-disabled="true"
                        >
                          <span class="bullet-dot" aria-hidden="true" />
                          <div>
                            <div class="subtopic-title">{topic.title}</div>
                            <p>{topic.summary}</p>
                          </div>
                        </li>
                      )
                    )}
                    <li class="subtopic-bullet module-link-bullet">
                      <a class="subtopic-link" href={buildModuleHref(module)}>
                        <span class="bullet-dot" aria-hidden="true" />
                        <div>
                          <div class="subtopic-title">
                            Visitar la página del módulo
                          </div>
                          <p>
                            Vista completa, recursos y artefactos para este
                            módulo.
                          </p>
                        </div>
                      </a>
                    </li>
                  </ul>
                ) : (
                  <ul class="subtopic-list">
                    <li class="subtopic-bullet disabled" aria-disabled="true">
                      <span class="bullet-dot" aria-hidden="true" />
                      <div>
                        <div class="subtopic-title">Próximamente</div>
                        <p>Los temas de este módulo aparecerán aquí.</p>
                      </div>
                    </li>
                  </ul>
                )}
              </div>
            </details>
          );
        })
      }
    </div>
  </section>
</BaseLayout>
