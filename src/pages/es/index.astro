---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';

const entries = await getCollection('ai-lab');
const englishTopics = await getCollection('topics');
const spanishTopics = await getCollection('topics-es');
const sorted = entries.sort(
  (a, b) => b.data.date.getTime() - a.data.date.getTime()
);
const logs = sorted.filter((entry) => entry.data.category === 'log');
const experiments = sorted.filter(
  (entry) => entry.data.category === 'experiment'
);
const bootstrappingSlug = logs.find((log) =>
  log.slug.includes('bootstrapping')
)?.slug;

const normalizeModuleKey = (value: string) => {
  const rawKey = value.split(':')[0].trim();
  return rawKey.replace('Módulo', 'Module').replace('Modulo', 'Module');
};

const formatModuleKey = (value: string) => value.replace('Module', 'Módulo');

const moduleSubtopics: Record<
  string,
  { id: string; title: string; summary: string }[]
> = {
  'Module 0': [
    {
      id: 'running-inference-locally',
      title: 'Ejecutar inferencia localmente',
      summary: 'Configura y ejecuta un LLM en tu propia máquina con facilidad.'
    },
    {
      id: 'agent-notifications',
      title: 'Notificaciones del agente',
      summary: 'Recibe notificaciones cuando tu agente termina usando hooks y ntfy.'
    },
    {
      id: 'access-secrets',
      title: 'Acceso y secretos',
      summary: 'Configura claves de API y secretos de forma segura para el acceso al modelo.'
    },
    {
      id: 'safety-baseline',
      title: 'Base de seguridad',
      summary: 'Aprende conceptos básicos de seguridad como inyección de prompts, uso indebido y manejo de datos.'
    }
  ],
  'Module 1': [
    {
      id: 'multi-tool-workflows',
      title: 'Flujos de trabajo multi-herramienta',
      summary: 'Ejecutar 3+ herramientas de IA en paralelo, eligiendo la correcta para cada tarea.'
    },
    {
      id: 'prompt-mastery',
      title: 'Dominio de prompts',
      summary: 'Más allá de lo básico — prompting estructurado, cadena de pensamiento, system prompts, versionado.'
    },
    {
      id: 'model-selection-economics',
      title: 'Selección de modelos y economía',
      summary: 'Cuándo usar Opus vs Sonnet vs Haiku, optimización de cuotas, conciencia de costos.'
    },
    {
      id: 'voice-multimodal-workflows',
      title: 'Flujos de voz y multimodales',
      summary: 'Pipelines de voz a IA, análisis de imágenes, integración de transcripción de audio.'
    }
  ],
  'Module 2': [
    {
      id: 'persistent-agents',
      title: 'Agentes persistentes',
      summary: 'Agentes 24/7 en infraestructura cloud — asistencia IA siempre activa.'
    },
    {
      id: 'automation-pipelines',
      title: 'Pipelines de automatización',
      summary: 'Flujos de IA con cron, procesamiento multi-etapa, análisis nocturno.'
    },
    {
      id: 'ai-first-lifestyle',
      title: 'Estilo de vida AI-first',
      summary: 'Briefings matutinos, planificación estratégica con IA, sistemas de memoria para continuidad.'
    },
    {
      id: 'content-distribution',
      title: 'Contenido y distribución',
      summary: 'Creación de contenido aumentada con IA, publicación multiplataforma, analíticas.'
    }
  ],
  'Module 3': [
    {
      id: 'llm-interfaces',
      title: 'Interfaces de LLM',
      summary: 'Bibliotecas cliente, patrones de solicitud/respuesta, streaming.'
    },
    {
      id: 'inputs-outputs',
      title: 'Entradas y salidas',
      summary: 'Prompts estructurados, salidas JSON/herramientas, function calling.'
    },
    {
      id: 'embeddings-vector-basics',
      title: 'Embeddings y vectores básicos',
      summary: 'Entender embeddings, búsqueda por similitud, cuándo necesitas vectores.'
    },
    {
      id: 'prompting-reasoning-patterns',
      title: 'Patrones de prompting y razonamiento',
      summary: 'Prompting avanzado, CoT, evaluación, micro-herramientas.'
    }
  ],
  'Module 4': [
    {
      id: 'vector-databases',
      title: 'Bases de datos vectoriales',
      summary: 'ChromaDB, pgvector, Pinecone — configuración y comparación.'
    },
    {
      id: 'document-indexing-chunking',
      title: 'Indexación y chunking de documentos',
      summary: 'Procesar tu propio contenido para búsqueda semántica.'
    },
    {
      id: 'rag-pipeline-design',
      title: 'Diseño de pipelines RAG',
      summary: 'Generación aumentada por recuperación de extremo a extremo.'
    },
    {
      id: 'observability',
      title: 'Observabilidad',
      summary: 'LangSmith, Langfuse — trazas, evaluación, seguimiento de costos.'
    }
  ],
  'Module 5': [
    {
      id: 'agent-frameworks',
      title: 'Frameworks de agentes',
      summary: 'LangGraph, CrewAI — orquestación multi-agente.'
    },
    {
      id: 'mcp-protocol',
      title: 'Protocolo MCP',
      summary: 'Model Context Protocol — construir servidores de herramientas para IA.'
    },
    {
      id: 'control-flow-state',
      title: 'Flujo de control y estado',
      summary: 'Máquinas de estado, cadenas de razonamiento, patrones de uso de herramientas.'
    },
    {
      id: 'resilience-reliability',
      title: 'Resiliencia y fiabilidad',
      summary: 'Fallos, reintentos, degradaciones con gracia, monitoreo de salud.'
    }
  ],
  'Module 6': [
    {
      id: 'local-model-serving',
      title: 'Servir modelos localmente',
      summary: 'Ollama, vLLM — optimización de costos, privacidad, experimentos de fine-tuning.'
    },
    {
      id: 'packaging-deployment',
      title: 'Empaquetado y despliegue',
      summary: 'Herramientas CLI, web UIs (Streamlit/FastAPI), Docker.'
    },
    {
      id: 'evaluation-frameworks',
      title: 'Frameworks de evaluación',
      summary: 'Testing sistemático de prompts, evaluación A/B, scoring de calidad.'
    },
    {
      id: 'shipping-ai-products',
      title: 'Lanzar productos de IA',
      summary: 'De infraestructura personal a productos que otros usan.'
    }
  ]
};

const buildTopicKey = (topic) => {
  const moduleKey = normalizeModuleKey(topic.data.module);
  return `${moduleKey}:${topic.data.subtopic}`;
};

const englishTopicLookup = englishTopics.reduce((acc, topic) => {
  acc.set(buildTopicKey(topic), topic);
  return acc;
}, new Map<string, (typeof englishTopics)[number]>());

const spanishTopicLookup = spanishTopics.reduce((acc, topic) => {
  acc.set(buildTopicKey(topic), topic);
  return acc;
}, new Map<string, (typeof spanishTopics)[number]>());

const buildTopicHref = (slug: string) => `/es/topics/${slug}/`;

const buildModuleHref = (module) => {
  if (module.link && module.link !== '#') return module.link;
  return '/program';
};

const moduleLadder = [
  {
    key: 'Module 0',
    title: 'Configuración rápida',
    status: 'in-progress',
    link: '/es/modules/module-0/',
    subtopics: moduleSubtopics['Module 0']
  },
  {
    key: 'Module 1',
    title: 'AI Power User',
    status: 'planned',
    link: '/modules/module-1/',
    subtopics: moduleSubtopics['Module 1']
  },
  {
    key: 'Module 2',
    title: 'Integración y orquestación de IA',
    status: 'planned',
    link: '/modules/module-2/',
    subtopics: moduleSubtopics['Module 2']
  },
  {
    key: 'Module 3',
    title: 'Fundamentos de builder',
    status: 'planned',
    link: '/modules/module-3/',
    subtopics: moduleSubtopics['Module 3']
  },
  {
    key: 'Module 4',
    title: 'RAG y sistemas de recuperación',
    status: 'planned',
    link: '/modules/module-4/',
    subtopics: moduleSubtopics['Module 4']
  },
  {
    key: 'Module 5',
    title: 'Arquitectura de agentes',
    status: 'planned',
    link: '/modules/module-5/',
    subtopics: moduleSubtopics['Module 5']
  },
  {
    key: 'Module 6',
    title: 'Sistemas de IA en producción',
    status: 'planned',
    link: '/modules/module-6/',
    subtopics: moduleSubtopics['Module 6']
  }
];

const currentModule =
  moduleLadder.find((item) => item.status === 'in-progress') ?? moduleLadder[0];

const logEntries = await Promise.all(
  logs.map(async (entry) => {
    const { Content } = await entry.render();
    return { ...entry, Content };
  })
);

const experimentCards = await Promise.all(
  experiments.map(async (entry) => {
    const { Content } = await entry.render();
    return { ...entry, Content };
  })
);

const subtopicsForModule = (module) => {
  return (module.subtopics ?? []).map((definition) => {
    const key = `${module.key}:${definition.id}`;
    const spanishTopic = spanishTopicLookup.get(key);
    const topic = spanishTopic ?? englishTopicLookup.get(key);
    const href = topic ? buildTopicHref(topic.slug) : undefined;
    const hasContent = Boolean(topic);

    return {
      title: definition.title,
      summary: spanishTopic?.data.summary ?? definition.summary,
      href,
      disabled: !hasContent
    };
  });
};
---

<BaseLayout
  title="AI Lab"
  description="Laboratorio de IA personal para seguir el crecimiento de cero a un practicante sólido."
>
  <section class="card signal-hero" aria-labelledby="hero-title">
    <div class="signal-overlay" aria-hidden="true"></div>
    <div class="signal-grid" aria-hidden="true"></div>
    <div class="hero-content">
      <h1 id="hero-title">AI Power User → Builder</h1>
      <p>
        Ruta acelerada desde el dominio de la integración con IA hasta la construcción de sistemas de IA en producción.
        Empieza donde la mayoría de desarrolladores no están — y llega donde casi nadie llega.
      </p>
    </div>
  </section>

  <section class="card featured" aria-labelledby="openclaw-title">
    <div class="section-title">
      <div>
        <p class="pill inline">Destacado</p>
        <h2 id="openclaw-title">OpenClaw</h2>
      </div>
    </div>
    <p>
      Explora agentes IA persistentes, despliegue en la nube y patrones avanzados de agentes en nuestro espacio dedicado de OpenClaw.
    </p>
    <a href="https://openclaw.turtleand.com/" class="pill inline" target="_blank" rel="noopener">
      Visitar OpenClaw →
    </a>
  </section>

  <section class="card" aria-labelledby="modules-title" id="modules">
    <div class="section-title">
      <div>
        <h2 id="modules-title">Hoja de ruta del programa</h2>
      </div>
      <small
        >Toca un módulo para ver sus temas y saltar a las páginas dedicadas.</small
      >
    </div>
    <div class="stacked">
      {
        moduleLadder.map((module) => {
          const renderedSubtopics = subtopicsForModule(module);
          const hasSubtopics = renderedSubtopics.length > 0;
          const activeSubtopics = renderedSubtopics.filter(
            (topic) => !topic.disabled
          );
          const moduleDisabled = activeSubtopics.length === 0;

          return (
            <details
              class={`module-row ${moduleDisabled ? 'disabled' : ''}`}
              open={
                !moduleDisabled &&
                hasSubtopics &&
                module.status === 'in-progress'
              }
            >
              <summary>
                <div>
                  <strong>{formatModuleKey(module.key)}</strong>
                  <div>{module.title}</div>
                </div>
              </summary>
              <div class="subtopics">
                {hasSubtopics ? (
                  <ul class="subtopic-list">
                    {renderedSubtopics.map((topic) =>
                      topic.href && !topic.disabled ? (
                        <li class="subtopic-bullet">
                          <a class="subtopic-link" href={topic.href}>
                            <span class="bullet-dot" aria-hidden="true" />
                            <div>
                              <div class="subtopic-title">{topic.title}</div>
                              <p>{topic.summary}</p>
                            </div>
                          </a>
                        </li>
                      ) : (
                        <li
                          class="subtopic-bullet disabled"
                          aria-disabled="true"
                        >
                          <span class="bullet-dot" aria-hidden="true" />
                          <div>
                            <div class="subtopic-title">{topic.title}</div>
                            <p>{topic.summary}</p>
                          </div>
                        </li>
                      )
                    )}
                    <li class="subtopic-bullet module-link-bullet">
                      <a class="subtopic-link" href={buildModuleHref(module)}>
                        <span class="bullet-dot" aria-hidden="true" />
                        <div>
                          <div class="subtopic-title">
                            Visitar la página del módulo
                          </div>
                          <p>
                            Vista completa, recursos y artefactos para este
                            módulo.
                          </p>
                        </div>
                      </a>
                    </li>
                  </ul>
                ) : (
                  <ul class="subtopic-list">
                    <li class="subtopic-bullet disabled" aria-disabled="true">
                      <span class="bullet-dot" aria-hidden="true" />
                      <div>
                        <div class="subtopic-title">Próximamente</div>
                        <p>Los temas de este módulo aparecerán aquí.</p>
                      </div>
                    </li>
                  </ul>
                )}
              </div>
            </details>
          );
        })
      }
    </div>
  </section>
</BaseLayout>
