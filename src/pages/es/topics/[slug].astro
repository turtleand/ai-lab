---
import BaseLayout from '../../../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';

export const prerender = true;

export async function getStaticPaths() {
  const topics = await getCollection('topics');
  return topics.map((topic) => ({
    params: { slug: topic.slug },
    props: { topic }
  }));
}

const { topic } = Astro.props;
const { Content } = await topic.render();

const resolveLink = (link?: string) => {
  if (!link) return undefined;
  if (link.startsWith('/topics/')) return `/es${link}`;
  return link;
};
---

<BaseLayout title={topic.data.title} description={topic.data.summary}>
  <section class="card" aria-labelledby="topic-title-es">
    <div class="pill inline">{topic.data.module}</div>
    <h1 id="topic-title-es">{topic.data.title}</h1>
    <p>{topic.data.summary}</p>
    <div class="tag-row">
      <span class={`status ${topic.data.status}`}>{topic.data.status}</span>
      <a class="pill" href="/es">Volver al programa</a>
    </div>
  </section>

  <section class="card" aria-labelledby="topic-content-es">
    <div class="section-title">
      <div>
        <p class="pill inline">Notas del tema</p>
        <h2 id="topic-content-es">Descripción general</h2>
      </div>
      <small>Alcance, artefactos iniciales y quick wins</small>
    </div>
    <article class="stacked">
      <Content />
    </article>
  </section>

  <section class="card" aria-labelledby="articles-title-es">
    <div class="section-title">
      <div>
        <p class="pill inline">Artículos y proyectos</p>
        <h2 id="articles-title-es">Trabajo en este tema</h2>
      </div>
      <small>Notas, experimentos y guías prácticas</small>
    </div>
    <div class="stacked">
      {topic.data.articles.map((item) => (
        <article class="subtopic-card">
          <div class="section-title">
            <h3>{item.title}</h3>
            <span class={`status ${item.status}`}>{item.status}</span>
          </div>
          <p>{item.description}</p>
          {resolveLink(item.link) && (
            <a class="pill inline" href={resolveLink(item.link)}>
              Abrir
            </a>
          )}
          <small style="color: var(--muted); text-transform: capitalize;">
            Tipo: {item.type}
          </small>
        </article>
      ))}
    </div>
  </section>
</BaseLayout>
