---
import BaseLayout from '../layouts/BaseLayout.astro';
import PortalDuo from '../components/PortalDuo.astro';
import { getCollection } from 'astro:content';

const entries = await getCollection('ai-lab');
const topicEntries = await getCollection('topics');
const sorted = entries.sort(
  (a, b) => b.data.date.getTime() - a.data.date.getTime()
);
const logs = sorted.filter((entry) => entry.data.category === 'log');
const experiments = sorted.filter(
  (entry) => entry.data.category === 'experiment'
);
const bootstrappingSlug = logs.find((log) =>
  log.slug.includes('bootstrapping')
)?.slug;

const normalizeModuleKey = (value: string) => value.split(':')[0].trim();

const moduleSubtopics: Record<
  string,
  { id: string; title: string; summary: string }[]
> = {
  'Module 0': [
    {
      id: 'running-inference-locally',
      title: 'Running inference locally',
      summary: 'Easily setup & run an LLM on your own machine.'
    },
    {
      id: 'agent-notifications',
      title: 'Agent notifications',
      summary: 'Get notified when your agent finishes using hooks and ntfy.'
    },
    {
      id: 'access-secrets',
      title: 'Access & secrets',
      summary: 'Configure API keys and secrets securely for model access.'
    },
    {
      id: 'safety-baseline',
      title: 'Safety baseline',
      summary:
        'Learn basic safety concepts such as prompt injection, misuse, and data handling.'
    }
  ],
  'Module 1': [
    {
      id: 'multi-tool-workflows',
      title: 'Multi-tool AI workflows',
      summary: 'Running 3+ AI tools in parallel, choosing the right tool for each task.'
    },
    {
      id: 'prompt-mastery',
      title: 'Prompt mastery',
      summary: 'Beyond basics — structured prompting, chain-of-thought, system prompts, prompt versioning.'
    },
    {
      id: 'model-selection-economics',
      title: 'Model selection & economics',
      summary: 'When to use Opus vs Sonnet vs Haiku, quota optimization, cost awareness.'
    },
    {
      id: 'voice-multimodal-workflows',
      title: 'Voice & multimodal workflows',
      summary: 'Voice-to-AI pipelines, image analysis, audio transcription integration.'
    }
  ],
  'Module 2': [
    {
      id: 'persistent-agents',
      title: 'Persistent AI agents',
      summary: '24/7 agents on cloud infrastructure — always-on AI assistance.'
    },
    {
      id: 'automation-pipelines',
      title: 'Automation pipelines',
      summary: 'Cron-driven AI workflows, multi-stage processing, overnight analysis.'
    },
    {
      id: 'ai-first-lifestyle',
      title: 'AI-first lifestyle',
      summary: 'Morning briefings, strategic planning with AI, memory systems for agent continuity.'
    },
    {
      id: 'content-distribution',
      title: 'Content & distribution',
      summary: 'AI-augmented content creation, cross-platform publishing, analytics.'
    }
  ],
  'Module 3': [
    {
      id: 'llm-interfaces',
      title: 'LLM interfaces',
      summary: 'Client libraries, request/response patterns, streaming.'
    },
    {
      id: 'inputs-outputs',
      title: 'Inputs & outputs',
      summary: 'Structured prompts, JSON/tool outputs, function calling.'
    },
    {
      id: 'embeddings-vector-basics',
      title: 'Embeddings & vector basics',
      summary: 'Understanding embeddings, similarity search, when you need vectors.'
    },
    {
      id: 'prompting-reasoning-patterns',
      title: 'Prompting & reasoning patterns',
      summary: 'Advanced prompting, CoT, evaluation, micro-tools.'
    }
  ],
  'Module 4': [
    {
      id: 'vector-databases',
      title: 'Vector databases',
      summary: 'ChromaDB, pgvector, Pinecone — setup and comparison.'
    },
    {
      id: 'document-indexing-chunking',
      title: 'Document indexing & chunking',
      summary: 'Processing your own content for semantic search.'
    },
    {
      id: 'rag-pipeline-design',
      title: 'RAG pipeline design',
      summary: 'End-to-end retrieval-augmented generation.'
    },
    {
      id: 'observability',
      title: 'Observability',
      summary: 'LangSmith, Langfuse — tracing, evaluation, cost tracking.'
    }
  ],
  'Module 5': [
    {
      id: 'agent-frameworks',
      title: 'Agent frameworks',
      summary: 'LangGraph, CrewAI — multi-agent orchestration.'
    },
    {
      id: 'mcp-protocol',
      title: 'MCP protocol',
      summary: 'Model Context Protocol — building tool servers for AI.'
    },
    {
      id: 'control-flow-state',
      title: 'Control flow & state',
      summary: 'State machines, reasoning chains, tool use patterns.'
    },
    {
      id: 'resilience-reliability',
      title: 'Resilience & reliability',
      summary: 'Failures, retries, graceful fallbacks, health monitoring.'
    }
  ],
  'Module 6': [
    {
      id: 'local-model-serving',
      title: 'Local model serving',
      summary: 'Ollama, vLLM — cost optimization, privacy, fine-tuning experiments.'
    },
    {
      id: 'packaging-deployment',
      title: 'Packaging & deployment',
      summary: 'CLI tools, web UIs (Streamlit/FastAPI), Docker.'
    },
    {
      id: 'evaluation-frameworks',
      title: 'Evaluation frameworks',
      summary: 'Systematic prompt testing, A/B evaluation, quality scoring.'
    },
    {
      id: 'shipping-ai-products',
      title: 'Shipping AI products',
      summary: 'From personal infrastructure to products others use.'
    }
  ]
};

const topicLookup = topicEntries.reduce((acc, topic) => {
  const moduleKey = normalizeModuleKey(topic.data.module);
  const key = `${moduleKey}:${topic.data.subtopic}`;
  acc.set(key, topic);
  return acc;
}, new Map<string, (typeof topicEntries)[number]>());

const buildTopicHref = (slug: string) => `/topics/${slug}/`;

const buildModuleHref = (module) => {
  if (module.link && module.link !== '#') return module.link;
  return '/program';
};

const moduleLadder = [
  {
    key: 'Module 0',
    title: 'Fast Track Setup',
    status: 'in-progress',
    link: '/modules/module-0/',
    subtopics: moduleSubtopics['Module 0']
  },
  {
    key: 'Module 1',
    title: 'AI Power User',
    status: 'planned',
    link: '/modules/module-1/',
    subtopics: moduleSubtopics['Module 1']
  },
  {
    key: 'Module 2',
    title: 'AI Integration & Orchestration',
    status: 'planned',
    link: '/modules/module-2/',
    subtopics: moduleSubtopics['Module 2']
  },
  {
    key: 'Module 3',
    title: 'Builder Foundations',
    status: 'planned',
    link: '/modules/module-3/',
    subtopics: moduleSubtopics['Module 3']
  },
  {
    key: 'Module 4',
    title: 'RAG & Retrieval Systems',
    status: 'planned',
    link: '/modules/module-4/',
    subtopics: moduleSubtopics['Module 4']
  },
  {
    key: 'Module 5',
    title: 'Agent Architecture',
    status: 'planned',
    link: '/modules/module-5/',
    subtopics: moduleSubtopics['Module 5']
  },
  {
    key: 'Module 6',
    title: 'Production AI Systems',
    status: 'planned',
    link: '/modules/module-6/',
    subtopics: moduleSubtopics['Module 6']
  }
];

const currentModule =
  moduleLadder.find((item) => item.status === 'in-progress') ?? moduleLadder[0];

const logEntries = await Promise.all(
  logs.map(async (entry) => {
    const { Content } = await entry.render();
    return { ...entry, Content };
  })
);

const experimentCards = await Promise.all(
  experiments.map(async (entry) => {
    const { Content } = await entry.render();
    return { ...entry, Content };
  })
);

const subtopicsForModule = (module) => {
  return (module.subtopics ?? []).map((definition) => {
    const key = `${module.key}:${definition.id}`;
    const topic = topicLookup.get(key);
    const href = topic ? buildTopicHref(topic.slug) : undefined;
    const hasContent = Boolean(topic);

    return {
      title: definition.title,
      summary: topic?.data.summary ?? definition.summary,
      href,
      disabled: !hasContent
    };
  });
};
---

<BaseLayout
  title="AI Lab"
  description="Personal AI Lab to track growth from zero to strong practitioner."
>
  <section class="card signal-hero" aria-labelledby="hero-title">
    <div class="signal-overlay" aria-hidden="true"></div>
    <div class="signal-grid" aria-hidden="true"></div>
    <div class="hero-content">
      <h1 id="hero-title">AI Power User → Builder</h1>
      <p>
        Fast-track path from AI integration mastery to building production AI systems.
        Start where most developers aren't — then go where almost nobody is.
      </p>
    </div>
  </section>

  <PortalDuo />

  <section class="card" aria-labelledby="modules-title" id="modules">
    <div class="section-title">
      <div>
        <h2 id="modules-title">Program roadmap</h2>
      </div>
    </div>
    <div class="stacked">
      {
        moduleLadder.map((module) => {
          const renderedSubtopics = subtopicsForModule(module);
          const hasSubtopics = renderedSubtopics.length > 0;
          const activeSubtopics = renderedSubtopics.filter(
            (topic) => !topic.disabled
          );
          const moduleDisabled = activeSubtopics.length === 0;

          return (
            <details
              class={`module-row ${moduleDisabled ? 'disabled' : ''}`}
              open={
                !moduleDisabled &&
                hasSubtopics &&
                module.status === 'in-progress'
              }
            >
              <summary>
                <div>
                  <strong>{module.key}</strong>
                  <div>{module.title}</div>
                </div>
              </summary>
              <div class="subtopics">
                {hasSubtopics ? (
                  <ul class="subtopic-list">
                    {renderedSubtopics.map((topic) =>
                      topic.href && !topic.disabled ? (
                        <li class="subtopic-bullet">
                          <a class="subtopic-link" href={topic.href}>
                            <span class="bullet-dot" aria-hidden="true" />
                            <div>
                              <div class="subtopic-title">{topic.title}</div>
                              <p>{topic.summary}</p>
                            </div>
                          </a>
                        </li>
                      ) : (
                        <li
                          class="subtopic-bullet disabled"
                          aria-disabled="true"
                        >
                          <span class="bullet-dot" aria-hidden="true" />
                          <div>
                            <div class="subtopic-title">{topic.title}</div>
                            <p>{topic.summary}</p>
                          </div>
                        </li>
                      )
                    )}
                    <li class="subtopic-bullet module-link-bullet">
                      <a class="subtopic-link" href={buildModuleHref(module)}>
                        <span class="bullet-dot" aria-hidden="true" />
                        <div>
                          <div class="subtopic-title">Visit module page</div>
                          <p>
                            Full overview, resources, and artifacts for this
                            module.
                          </p>
                        </div>
                      </a>
                    </li>
                  </ul>
                ) : (
                  <ul class="subtopic-list">
                    <li class="subtopic-bullet disabled" aria-disabled="true">
                      <span class="bullet-dot" aria-hidden="true" />
                      <div>
                        <div class="subtopic-title">Coming soon</div>
                        <p>Topics for this module will appear here.</p>
                      </div>
                    </li>
                  </ul>
                )}
              </div>
            </details>
          );
        })
      }
    </div>
  </section>
</BaseLayout>
