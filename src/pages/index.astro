---
import BaseLayout from '../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';

const entries = await getCollection('ai-lab');
const topicEntries = await getCollection('topics');
const sorted = entries.sort(
  (a, b) => b.data.date.getTime() - a.data.date.getTime()
);
const logs = sorted.filter((entry) => entry.data.category === 'log');
const experiments = sorted.filter(
  (entry) => entry.data.category === 'experiment'
);
const bootstrappingSlug = logs.find((log) =>
  log.slug.includes('bootstrapping')
)?.slug;

const normalizeModuleKey = (value: string) => value.split(':')[0].trim();

const moduleSubtopics: Record<
  string,
  { id: string; title: string; summary: string }[]
> = {
  'Module 0': [
    {
      id: 'running-inference-locally',
      title: 'Running inference locally',
      summary: 'Easily setup & run an LLM on your own machine.'
    },
    {
      id: 'access-secrets',
      title: 'Access & secrets',
      summary: 'Configure API keys and secrets securely for model access.'
    },
    {
      id: 'safety-baseline',
      title: 'Safety baseline',
      summary:
        'Learn basic safety concepts such as prompt injection, misuse, and data handling.'
    }
  ],
  'Module 1': [
    {
      id: 'llm-interfaces',
      title: 'LLM interfaces',
      summary:
        'Work with LLM client libraries/runtimes and request/response patterns.'
    },
    {
      id: 'inputs-outputs',
      title: 'Inputs & outputs',
      summary:
        'Structure prompts, messages, and JSON/tool outputs for downstream use.'
    },
    {
      id: 'model-economics',
      title: 'Model economics',
      summary: 'Tokens, context windows, latency, and cost basics.'
    }
  ],
  'Module 2': [
    {
      id: 'prompt-structures',
      title: 'Prompt structures',
      summary: 'Roles, instructions, examples, CoT, and RAG-style hints.'
    },
    {
      id: 'output-evaluation',
      title: 'Output evaluation',
      summary: 'Compare good/bad outputs and tune prompts with feedback.'
    },
    {
      id: 'micro-tools',
      title: 'Micro-tools',
      summary: 'Small utilities like AI note cleaners or explainers.'
    }
  ],
  'Module 3': [
    {
      id: 'retrieval-basics',
      title: 'Retrieval basics',
      summary: 'Minimal RAG over local documents using embeddings and search.'
    },
    {
      id: 'tool-wiring',
      title: 'Tool wiring',
      summary: 'Hook models to search, calculator, or file/DB lookups.'
    },
    {
      id: 'observability',
      title: 'Observability',
      summary: 'Log prompts/outputs to debug and iterate reliably.'
    }
  ],
  'Module 4': [
    {
      id: 'agent-design',
      title: 'Agent design',
      summary: 'One or two small agents (research assistant, task automator).'
    },
    {
      id: 'control-flow',
      title: 'Control flow',
      summary: 'Compare state machines vs. looping-prompt approaches.'
    },
    {
      id: 'resilience',
      title: 'Resilience',
      summary: 'Handle failures, retries, and graceful fallbacks.'
    }
  ],
  'Module 5': [
    {
      id: 'packaging',
      title: 'Packaging',
      summary: 'Wrap a project into a CLI or simple web UI (Streamlit/FastAPI).'
    },
    {
      id: 'run-deploy',
      title: 'Run & deploy',
      summary: 'Document how to run locally and how to deploy it.'
    },
    {
      id: 'reality-check',
      title: 'Reality check',
      summary: 'Call out limitations, risks, and future improvements.'
    }
  ]
};

const topicLookup = topicEntries.reduce((acc, topic) => {
  const moduleKey = normalizeModuleKey(topic.data.module);
  const key = `${moduleKey}:${topic.data.subtopic}`;
  acc.set(key, topic);
  return acc;
}, new Map<string, (typeof topicEntries)[number]>());

const buildTopicHref = (slug: string) => `/topics/${slug}/`;

const buildModuleHref = (module) => {
  if (module.link && module.link !== '#') return module.link;
  return '/program';
};

const moduleLadder = [
  {
    key: 'Module 0',
    title: 'Setup & Safety',
    status: 'in-progress',
    link: '/modules/module-0/',
    subtopics: moduleSubtopics['Module 0']
  },
  {
    key: 'Module 1',
    title: 'Foundations for LLM Builders',
    status: 'planned',
    link: '/modules/module-1/',
    subtopics: moduleSubtopics['Module 1']
  },
  {
    key: 'Module 2',
    title: 'Prompting & Reasoning Patterns',
    status: 'planned',
    link: '/program#module-2',
    subtopics: moduleSubtopics['Module 2']
  },
  {
    key: 'Module 3',
    title: 'RAG & Tools Integration',
    status: 'planned',
    link: '/program#module-3',
    subtopics: moduleSubtopics['Module 3']
  },
  {
    key: 'Module 4',
    title: 'Agents & Workflows',
    status: 'planned',
    link: '/program#module-4',
    subtopics: moduleSubtopics['Module 4']
  },
  {
    key: 'Module 5',
    title: 'Productized LLM App',
    status: 'planned',
    link: '/program#module-5',
    subtopics: moduleSubtopics['Module 5']
  }
];

const currentModule =
  moduleLadder.find((item) => item.status === 'in-progress') ?? moduleLadder[0];

const logEntries = await Promise.all(
  logs.map(async (entry) => {
    const { Content } = await entry.render();
    return { ...entry, Content };
  })
);

const experimentCards = await Promise.all(
  experiments.map(async (entry) => {
    const { Content } = await entry.render();
    return { ...entry, Content };
  })
);

const subtopicsForModule = (module) => {
  return (module.subtopics ?? []).map((definition) => {
    const key = `${module.key}:${definition.id}`;
    const topic = topicLookup.get(key);
    const href = topic ? buildTopicHref(topic.slug) : undefined;
    const hasContent = Boolean(topic);

    return {
      title: definition.title,
      summary: topic?.data.summary ?? definition.summary,
      href,
      disabled: !hasContent
    };
  });
};
---

<BaseLayout
  title="AI Lab"
  description="Personal AI Lab to track growth from zero to strong practitioner."
>
  <section class="card signal-hero" aria-labelledby="hero-title">
    <div class="signal-overlay" aria-hidden="true"></div>
    <div class="signal-grid" aria-hidden="true"></div>
    <div class="hero-content">
      <h1 id="hero-title">LLM & GenAI Builder</h1>
      <p>
        <b>Self-learner</b> path for going from zero to shipping practical LLM-based
        tools and agents, with an emphasis on clarity, reproducibility, and real usage
        inside the Turtleand ecosystem.
      </p>
    </div>
  </section>

  <section class="card" aria-labelledby="modules-title" id="modules">
    <div class="section-title">
      <div>
        <h2 id="modules-title">Program roadmap</h2>
      </div>
    </div>
    <div class="stacked">
      {
        moduleLadder.map((module) => {
          const renderedSubtopics = subtopicsForModule(module);
          const hasSubtopics = renderedSubtopics.length > 0;
          const activeSubtopics = renderedSubtopics.filter(
            (topic) => !topic.disabled
          );
          const moduleDisabled = activeSubtopics.length === 0;

          return (
            <details
              class={`module-row ${moduleDisabled ? 'disabled' : ''}`}
              open={
                !moduleDisabled &&
                hasSubtopics &&
                module.status === 'in-progress'
              }
            >
              <summary>
                <div>
                  <strong>{module.key}</strong>
                  <div>{module.title}</div>
                </div>
              </summary>
              <div class="subtopics">
                {hasSubtopics ? (
                  <ul class="subtopic-list">
                    {renderedSubtopics.map((topic) =>
                      topic.href && !topic.disabled ? (
                        <li class="subtopic-bullet">
                          <a class="subtopic-link" href={topic.href}>
                            <span class="bullet-dot" aria-hidden="true" />
                            <div>
                              <div class="subtopic-title">{topic.title}</div>
                              <p>{topic.summary}</p>
                            </div>
                          </a>
                        </li>
                      ) : (
                        <li
                          class="subtopic-bullet disabled"
                          aria-disabled="true"
                        >
                          <span class="bullet-dot" aria-hidden="true" />
                          <div>
                            <div class="subtopic-title">{topic.title}</div>
                            <p>{topic.summary}</p>
                          </div>
                        </li>
                      )
                    )}
                    <li class="subtopic-bullet module-link-bullet">
                      <a class="subtopic-link" href={buildModuleHref(module)}>
                        <span class="bullet-dot" aria-hidden="true" />
                        <div>
                          <div class="subtopic-title">Visit module page</div>
                          <p>
                            Full overview, resources, and artifacts for this
                            module.
                          </p>
                        </div>
                      </a>
                    </li>
                  </ul>
                ) : (
                  <ul class="subtopic-list">
                    <li class="subtopic-bullet disabled" aria-disabled="true">
                      <span class="bullet-dot" aria-hidden="true" />
                      <div>
                        <div class="subtopic-title">Coming soon</div>
                        <p>Topics for this module will appear here.</p>
                      </div>
                    </li>
                  </ul>
                )}
              </div>
            </details>
          );
        })
      }
    </div>
  </section>
</BaseLayout>
